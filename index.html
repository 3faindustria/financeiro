<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Financeiro 3FA</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .filter-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
        .summary-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #1976d2; }
        .total-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 1.1em; }
        .highlight { font-weight: bold; color: #1976d2; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #1976d2; color: white; }
        tr:nth-child(even) { background: #fafafa; }
        select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        button { background: #1976d2; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #1565c0; }
    </style>
</head>
<body>

<div class="filter-section">
    <strong>Tipo de Lançamento:</strong>
    <select id="filtro-tipo">
        <option value="contasReceber">Contas a Receber</option>
        <option value="contasPagar">Contas a Pagar</option>
    </select>
    <button onclick="buscarDados()">Consultar</button>
</div>

<div class="summary-box">
    <div class="card">
        <h3>Resumo da Seleção</h3>
        <div class="total-row">
            <span>Total Previsto:</span>
            <span id="resumo-previsto" class="highlight">R$ 0,00</span>
        </div>
        <div class="total-row">
            <span>Total Realizado:</span>
            <span id="resumo-realizado" class="highlight">R$ 0,00</span>
        </div>
        <div class="total-row" style="border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px;">
            <strong>Saldo Total:</strong>
            <strong id="resumo-saldo" style="color: #2e7d32;">R$ 0,00</strong>
        </div>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Classificação</th>
            <th>Pessoa</th>
            <th>Vencimento</th>
            <th>Descrição</th>
            <th>Valor Previsto</th>
            <th>Valor Realizado</th>
        </tr>
    </thead>
    <tbody id="tabela-corpo">
        <tr><td colspan="6" style="text-align:center">Selecione o filtro e clique em consultar.</td></tr>
    </tbody>
</table>

<script>
    function formatarMoeda(valor) {
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function stringParaNumero(str) {
        if (!str) return 0;
        return parseFloat(str.replace(/\./g, '').replace(',', '.'));
    }

    async function buscarDados() {
        const tipo = document.getElementById("filtro-tipo").value;
        const corpo = document.getElementById("tabela-corpo");
        corpo.innerHTML = '<tr><td colspan="6" style="text-align:center">Buscando no Nomus...</td></tr>';
    
        try {
            const response = await fetch(`/api/consultar?endpoint=${tipo}`);
            const dados = await response.json();
            let lista = Array.isArray(dados) ? dados : (dados.content || []);
    
            // --- LÓGICA DE ORDENAÇÃO POR VENCIMENTO ---
            // --- LÓGICA DE ORDENAÇÃO CORRIGIDA ---

            // ------------------------------------------
            // ------------------------------------------
    
            let totalPrevisto = 0;
            let totalRealizado = 0;
            corpo.innerHTML = "";
    
            lista.forEach(item => {
                const vPrev = stringParaNumero(item.valorReceber || item.valorPagar);
                const vReal = stringParaNumero(item.valorRecebido || item.valorPago);

                // Dentro do seu lista.forEach(item => { ... })
                const tr = document.createElement("tr");
                
                // Lógica para verificar atraso
                const hoje = new Date();
                const partesVenc = item.dataVencimento.split('/');
                const dataVenc = new Date(partesVenc[2], partesVenc[1] - 1, partesVenc[0]);
                const pendente = stringParaNumero(item.valorRecebido || item.valorPago) === 0;
                
                if (dataVenc < hoje && pendente) {
                    tr.style.backgroundColor = "#fff1f0"; // Fundo levemente avermelhado para atrasos
                    tr.style.color = "#cf1322"; // Texto em vermelho
                }
                
                totalPrevisto += vPrev;
                totalRealizado += vReal;
    
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.classificacao}</td>
                    <td>${item.nomePessoa}</td>
                    <td style="font-weight: bold;">${item.dataVencimento}</td>
                    <td>${item.descricaoLancamento}</td>
                    <td>${formatarMoeda(vPrev)}</td>
                    <td>${formatarMoeda(vReal)}</td>
                `;
                corpo.appendChild(tr);
            });
    
            document.getElementById("resumo-previsto").innerText = formatarMoeda(totalPrevisto);
            document.getElementById("resumo-realizado").innerText = formatarMoeda(totalRealizado);
            document.getElementById("resumo-saldo").innerText = formatarMoeda(totalPrevisto - totalRealizado);
    
        } catch (error) {
            corpo.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">Erro: ${error.message}</td></tr>`;
        }
    }
</script>
</body>
</html>
