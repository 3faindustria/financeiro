<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; }
        .summary-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .card.receber { border-left-color: #2e7d32; }
        .card.pagar { border-left-color: #d32f2f; }
        .card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .values { display: flex; justify-content: space-between; font-size: 13px; }
        .total-bold { font-weight: bold; font-size: 16px; color: #333; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #eee; }
    </style>
</head>
<body>

<div class="summary-box">
    <div class="card receber">
        <h3>A RECEBER</h3>
        <div class="values">
            <span>Previsto: <span id="total-receber">R$ 0,00</span></span>
            <span>Realizado: <span id="total-recebido">R$ 0,00</span></span>
            <span class="total-bold">Saldo: <span id="saldo-receber">R$ 0,00</span></span>
        </div>
    </div>
    <div class="card pagar">
        <h3>A PAGAR</h3>
        <div class="values">
            <span>Previsto: <span id="total-pagar">R$ 0,00</span></span>
            <span>Realizado: <span id="total-pago">R$ 0,00</span></span>
            <span class="total-bold">Saldo: <span id="saldo-pagar">R$ 0,00</span></span>
        </div>
    </div>
</div>

<button onclick="carregarDados()">Atualizar Financeiro</button>

<div style="margin-top:20px">
    <table>
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Vencimento</th>
                <th>Pessoa (Fornecedor/Cliente)</th>
                <th>Descrição</th>
                <th>Valor Previsto</th>
                <th>Valor Realizado</th>
                <th>Saldo</th>
            </tr>
        </thead>
        <tbody id="tabela-corpo"></tbody>
    </table>
</div>

<script>
    function formatarMoeda(valor) {
        // Converte a string do Nomus (ex: "48.785,07") para número e formata
        const num = parseFloat(valor.replace(/\./g, '').replace(',', '.'));
        return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    async function carregarDados() {
        const res = await fetch('/api/consultar');
        const { receber, pagar } = await res.json();
        
        let somaReceber = 0, somaRecebido = 0, somaPagar = 0, somaPago = 0;
        const corpo = document.getElementById("tabela-corpo");
        corpo.innerHTML = "";

        // Processar Receber
        receber.forEach(item => {
            const vR = parseFloat(item.valorReceber.replace(/\./g, '').replace(',', '.'));
            const vReal = parseFloat(item.valorRecebido.replace(/\./g, '').replace(',', '.'));
            somaReceber += vR; somaRecebido += vReal;
            adicionarLinha(item, "Receber", "#e8f5e9");
        });

        // Processar Pagar
        pagar.forEach(item => {
            const vP = parseFloat(item.valorPagar.replace(/\./g, '').replace(',', '.'));
            const vReal = parseFloat(item.valorPago.replace(/\./g, '').replace(',', '.'));
            somaPagar += vP; somaPago += vReal;
            adicionarLinha(item, "Pagar", "#ffebee");
        });

        // Atualizar Dashboard
        document.getElementById("total-receber").innerText = formatarMoeda(somaReceber.toFixed(2));
        document.getElementById("total-recebido").innerText = formatarMoeda(somaRecebido.toFixed(2));
        document.getElementById("saldo-receber").innerText = formatarMoeda((somaReceber - somaRecebido).toFixed(2));
        
        document.getElementById("total-pagar").innerText = formatarMoeda(somaPagar.toFixed(2));
        document.getElementById("total-pago").innerText = formatarMoeda(somaPago.toFixed(2));
        document.getElementById("saldo-pagar").innerText = formatarMoeda((somaPagar - somaPago).toFixed(2));
    }

    function adicionarLinha(item, tipo, cor) {
        const corpo = document.getElementById("tabela-corpo");
        const tr = document.createElement("tr");
        tr.style.backgroundColor = cor;
        const valorPrev = item.valorReceber || item.valorPagar;
        const valorReal = item.valorRecebido || item.valorPago;
        
        tr.innerHTML = `
            <td><b>${tipo}</b></td>
            <td>${item.dataVencimento}</td>
            <td>${item.nomePessoa}</td>
            <td>${item.descricaoLancamento}</td>
            <td>R$ ${valorPrev}</td>
            <td>R$ ${valorReal}</td>
            <td>R$ ${item.saldoReceber || item.saldoPagar}</td>
        `;
        corpo.appendChild(tr);
    }
</script>
</body>
</html>
