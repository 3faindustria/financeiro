<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Financeiro 3FA</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; }
        .filter-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; }
        .summary-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-top: 4px solid #1976d2; }
        .total-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 1.1em; }
        .highlight { font-weight: bold; color: #1976d2; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #1976d2; color: white; }
        tr:nth-child(even) { background: #fafafa; }
        select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        button { background: #1976d2; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #1565c0; }

        /* Estilo para destacar linhas vencidas */
        .linha-vencida {
            background-color: #fff1f0 !important; /* Fundo vermelho bem claro */
            color: #cf1322 !important;            /* Texto vermelho escuro */
        }
        .atraso-badge {
            background: #cf1322;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-left: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>

<div class="filter-section">
    <strong>Tipo de Lançamento:</strong>
    <select id="filtro-tipo">
        <option value="contasReceber">Contas a Receber</option>
        <option value="contasPagar">Contas a Pagar</option>
    </select>
    <button onclick="buscarDados()">Consultar</button>
</div>

<div class="summary-box">
    <div class="card">
        <h3>Resumo da Seleção</h3>
        <div class="total-row">
            <span>Total Previsto:</span>
            <span id="resumo-previsto" class="highlight">R$ 0,00</span>
        </div>
        <div class="total-row">
            <span>Total Realizado:</span>
            <span id="resumo-realizado" class="highlight">R$ 0,00</span>
        </div>
        <div class="total-row" style="border-top: 1px solid #eee; padding-top: 10px; margin-top: 15px;">
            <strong>Saldo Total:</strong>
            <strong id="resumo-saldo" style="color: #2e7d32;">R$ 0,00</strong>
        </div>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Classificação</th>
            <th>Pessoa</th>
            <th>Vencimento</th>
            <th>Descrição</th>
            <th>Valor Previsto</th>
            <th>Valor Realizado</th>
        </tr>
    </thead>
    <tbody id="tabela-corpo">
        <tr><td colspan="6" style="text-align:center">Selecione o filtro e clique em consultar.</td></tr>
    </tbody>
</table>

// Funções de utilidade (Devem estar no topo)
function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function stringParaNumero(str) {
    if (!str || typeof str !== 'string') return 0;
    // Remove pontos de milhar e troca vírgula por ponto
    return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
}

async function buscarDados() {
    const filtroElemento = document.getElementById("filtro-tipo");
    const corpo = document.getElementById("tabela-corpo");
    
    if (!filtroElemento || !corpo) {
        alert("Erro técnico: Elementos da página não encontrados.");
        return;
    }

    const tipo = filtroElemento.value;
    corpo.innerHTML = '<tr><td colspan="6" style="text-align:center">Buscando no Nomus...</td></tr>';

    try {
        const response = await fetch(`/api/consultar?endpoint=${tipo}`);
        if (!response.ok) throw new Error(`Erro no servidor: ${response.status}`);
        
        const dados = await response.json();
        let lista = Array.isArray(dados) ? dados : (dados.content || []);

        // --- ORDENAÇÃO SEGURA ---
        lista.sort((a, b) => {
            const extrairData = (item) => {
                const d = item.dataVencimento;
                if (!d || typeof d !== 'string') return new Date(0);
                const p = d.trim().split('/');
                return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]) : new Date(0);
            };
            return extrairData(a) - extrairData(b);
        });

        let totalPrevisto = 0;
        let totalRealizado = 0;
        corpo.innerHTML = "";

        if (lista.length === 0) {
            corpo.innerHTML = '<tr><td colspan="6" style="text-align:center">Nenhum dado encontrado para este filtro.</td></tr>';
        } else {
            lista.forEach(item => {
                const vPrev = stringParaNumero(item.valorReceber || item.valorPagar);
                const vReal = stringParaNumero(item.valorRecebido || item.valorPago);
                
                totalPrevisto += vPrev;
                totalRealizado += vReal;
            
                const tr = document.createElement("tr");
            
                // --- LÓGICA DE DESTAQUE DE VENCIDOS ---
                const partes = item.dataVencimento.split('/');
                const dataVenc = new Date(partes[2], partes[1] - 1, partes[0]);
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0); // Zera as horas para comparar apenas os dias
            
                // Se a data de vencimento for menor que hoje E não houve pagamento integral
                if (dataVenc < hoje && vReal < vPrev) {
                    tr.classList.add("linha-vencida");
                }
                // --------------------------------------
            
                tr.innerHTML = `
                    <td>${item.classificacao || '-'}</td>
                    <td>${item.nomePessoa || '-'}</td>
                    <td style="font-weight: bold;">
                        ${item.dataVencimento}
                        ${dataVenc < hoje && vReal < vPrev ? '<span class="atraso-badge">VENCIDO</span>' : ''}
                    </td>
                    <td>${item.descricaoLancamento || '-'}</td>
                    <td>${formatarMoeda(vPrev)}</td>
                    <td>${formatarMoeda(vReal)}</td>
                `;
                corpo.appendChild(tr);
            });
        }

        // Atualiza Resumo Financeiro
        document.getElementById("resumo-previsto").innerText = formatarMoeda(totalPrevisto);
        document.getElementById("resumo-realizado").innerText = formatarMoeda(totalRealizado);
        document.getElementById("resumo-saldo").innerText = formatarMoeda(totalPrevisto - totalRealizado);

    } catch (error) {
        console.error("Erro na consulta:", error);
        corpo.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red">Erro na comunicação: ${error.message}</td></tr>`;
    }
}
</body>
</html>
